<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Xcellent1 Lawn Care crew dashboard - today's jobs, navigation, photo upload"
    />
    <meta name="theme-color" content="#10b981" />
    <title>Today's Route | Xcellent1 Crew</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      /* Crew Dashboard Mobile-First Styles */
      body {
        padding-bottom: 80px; /* Space for bottom nav */
      }
      .crew-header {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 1.5rem;
        position: sticky;
        top: 0;
        z-index: 50;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .greeting {
        font-size: 1.25rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
      }
      .route-summary {
        display: flex;
        gap: 1.5rem;
        font-size: 0.875rem;
        opacity: 0.95;
      }
      .route-summary-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
      }

      /* Job Cards */
      .job-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border: 2px solid transparent;
        transition: all 0.2s;
      }
      .job-card.active {
        border-color: var(--color-primary);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.2);
      }
      .job-card.completed {
        opacity: 0.6;
      }
      .job-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
      }
      .job-number {
        font-size: 0.875rem;
        font-weight: 700;
        color: var(--color-text-secondary);
      }
      .job-time {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--color-primary);
      }
      .job-status {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
      }
      .job-status.pending {
        background: #fef3c7;
        color: #92400e;
      }
      .job-status.active {
        background: #dcfce7;
        color: #166534;
      }
      .job-status.completed {
        background: #e5e7eb;
        color: #374151;
      }

      .client-info {
        margin-bottom: 1rem;
      }
      .client-name {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
      }
      .client-address {
        color: var(--color-text-secondary);
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .service-list {
        background: var(--color-bg);
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 1rem;
      }
      .service-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        margin: 0.25rem 0;
      }
      .service-item input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      .job-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
        margin-top: 1rem;
      }
      .btn-navigate {
        background: #3b82f6;
        color: white;
      }
      .btn-navigate:active {
        background: #2563eb;
      }
      .btn-complete {
        background: var(--color-success);
        color: white;
      }
      .btn-complete:active {
        background: #16a34a;
      }

      /* Bottom Navigation */
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 1px solid var(--color-border);
        display: flex;
        justify-content: space-around;
        padding: 0.5rem 0;
        padding-bottom: 0.5rem;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        z-index: 100;
      }
      .nav-btn {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
        padding: 0.5rem;
        background: transparent;
        border: none;
        color: var(--color-text-secondary);
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: color 0.2s;
        min-width: 60px;
      }
      .nav-btn.active {
        color: var(--color-primary);
      }
      .nav-icon {
        font-size: 1.5rem;
      }

      /* Photo Upload Modal */
      .photo-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 200;
        padding: 1rem;
      }
      .photo-modal.active {
        display: flex;
        flex-direction: column;
      }
      .photo-modal-header {
        color: white;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .photo-modal-title {
        font-size: 1.125rem;
        font-weight: 700;
      }
      .photo-modal-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 1.5rem;
        cursor: pointer;
      }
      .photo-modal-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: 1rem;
      }
      .camera-preview {
        width: 100%;
        max-width: 500px;
        margin: 0 auto;
        border-radius: 12px;
        overflow: hidden;
        background: var(--color-bg);
      }
      .camera-preview img {
        width: 100%;
        height: auto;
        display: block;
      }
      .photo-type-selector {
        display: flex;
        gap: 0.5rem;
        margin: 1rem auto;
        max-width: 500px;
      }
      .photo-type-btn {
        flex: 1;
        padding: 0.75rem;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
      }
      .photo-type-btn.selected {
        background: white;
        color: var(--color-primary);
        border-color: white;
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="navbar-brand">
        <img
          src="images/xcellent1-logo-transparent.png"
          alt="Xcellent1 logo"
          class="navbar-logo"
        />
        <div class="navbar-title">
          <span class="navbar-name">XCELLENT1</span>
          <span class="navbar-tagline">LAWN CARE</span>
        </div>
      </div>
      <div class="navbar-links">
        <a href="crew.html" class="navbar-link active">My Jobs</a>
        <a href="#" onclick="document.getElementById('photo-modal').style.display='flex'; return false;" class="navbar-link">Photos</a>
        <button onclick="logout()" class="navbar-login navbar-button">Logout</button>
      </div>
    </nav>
    <!-- Crew Header -->
    <div class="crew-header">
      <div class="crew-header-layout">
        <div class="greeting" id="crew-greeting">Good morning, Marcus üëã</div>
        <button onclick="logout()" class="crew-logout-btn">
          Logout
        </button>
      </div>
      <div class="route-summary">
        <div class="route-summary-item">
          <span>üìÖ</span>
          <span id="route-date">Today</span>
        </div>
        <div class="route-summary-item">
          <span>üö©</span>
          <span
            ><strong id="jobs-completed">0</strong>/<strong id="jobs-total"
              >0</strong
            >
            Complete</span
          >
        </div>
        <div class="route-summary-item">
          <span>üìç</span>
          <span id="route-miles">0 mi</span>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <main class="container pt-sm">
      <div id="crew-status" role="alert" aria-live="polite"></div>

      <!-- Today's Jobs -->
      <div id="jobs-list">
        <div class="loading-container">
          <span class="spinner"></span>
          <span>Loading today's route...</span>
        </div>
      </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
      <button class="nav-btn active">
        <span class="nav-icon">üè†</span>
        <span>Today</span>
      </button>
      <button class="nav-btn">
        <span class="nav-icon">üìÖ</span>
        <span>Schedule</span>
      </button>
      <button class="nav-btn">
        <span class="nav-icon">üë§</span>
        <span>Profile</span>
      </button>
    </nav>

    <!-- Photo Upload Modal -->
    <div id="photo-modal" class="photo-modal">
      <div class="photo-modal-header">
        <div class="photo-modal-title" id="photo-modal-title">
          Upload Job Photo
        </div>
        <button class="photo-modal-close" onclick="closePhotoUpload()">
          &times;
        </button>
      </div>
      <div class="photo-modal-body">
        <input
          type="file"
          id="photo-input"
          accept="image/*"
          capture="environment"
          class="hidden"
        />
        <div
          id="photo-preview"
          class="camera-preview hidden"
        ></div>
        <div class="photo-type-selector">
          <button
            class="photo-type-btn selected"
            data-type="before"
            onclick="selectPhotoType('before')"
          >
            Before
          </button>
          <button
            class="photo-type-btn"
            data-type="after"
            onclick="selectPhotoType('after')"
          >
            After
          </button>
        </div>
        <button
          class="btn btn-centered"
          onclick="triggerCamera()"
        >
          üì∏ Take Photo
        </button>
        <button
          id="upload-photo-btn"
          class="btn btn-centered-mt hidden"
          onclick="uploadPhoto()"
        >
          üì§ Upload Photo
        </button>
      </div>
    </div>

    <!-- JavaScript -->
    <script src="app.js"></script>
    <script type="module">
      import { requireAuth, logout } from "auth-helper.js";

      // Require crew authentication
      const userProfile = await requireAuth("crew", ".greeting");

      // Export for use in other scripts
      window.crewProfile = userProfile;
    </script>
    <script>
      // Crew Dashboard Logic
      const CREW_ID = window.crewProfile?.id || "crew_marcus_01"; // Get from auth
      let currentJob = null;
      let photoType = "before";
      let capturedPhoto = null;
      let jobsData = [];

      // Fetch crew jobs from API
      async function fetchCrewJobs() {
        try {
          const token = window.supabaseSession?.access_token;
          if (!token) {
            throw new Error("No authentication token");
          }

          const response = await fetch(`/api/crew/${CREW_ID}/jobs`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            throw new Error(`API error: ${response.status}`);
          }

          const data = await response.json();
          if (!data.ok) {
            throw new Error(data.error || "Failed to fetch jobs");
          }

          return data.jobs || [];
        } catch (err) {
          console.error("Failed to fetch crew jobs:", err);
          showMessage(
            "crew-status",
            "‚ö†Ô∏è Unable to load jobs. Please refresh the page.",
            "warning",
            5000
          );
          return [];
        }
      }

      // Load crew jobs
      async function loadCrewJobs() {
        // Fetch jobs from API
        const apiJobs = await fetchCrewJobs();

        // Transform API data to match expected format
        jobsData = apiJobs.map((job) => ({
          id: job.id,
          time: job.scheduled_time || "TBD",
          client: job.client_name || "Unknown Client",
          address: job.property_address?.split(",")[0] || "",
          city: job.property_address?.split(",").slice(1).join(",") || "",
          services:
            typeof job.services === "string"
              ? job.services.split(",")
              : Array.isArray(job.services)
                ? job.services
                : [],
          notes: job.notes || "",
          duration: job.estimated_duration || 60,
          status: job.status || "pending",
        }));
        const now = new Date();
        const hour = now.getHours();
        const greeting =
          hour < 12
            ? "Good morning"
            : hour < 18
              ? "Good afternoon"
              : "Good evening";
        document.getElementById("crew-greeting").textContent =
          greeting + ", Marcus üëã";

        const dateStr = now.toLocaleDateString("en-US", {
          weekday: "short",
          month: "short",
          day: "numeric",
        });
        document.getElementById("route-date").textContent = dateStr;

        // Calculate stats
        const completed = jobsData.filter((j) => j.status === "completed").length;
        document.getElementById("jobs-completed").textContent = completed;
        document.getElementById("jobs-total").textContent = jobsData.length;
        document.getElementById("route-miles").textContent = "0 mi"; // TODO: Calculate route distance

        renderJobs(jobsData);
      }

      // Render job list
      function renderJobs(jobs) {
        const container = document.getElementById("jobs-list");
        if (jobs.length === 0) {
          container.innerHTML =
            '<div class="empty-state"><p class="text-muted">üéâ No jobs today! Enjoy your day off.</p></div>';
          return;
        }

        container.innerHTML = jobs
          .map((job) => {
            const activeClass = job.status === "active" ? "active" : "";
            const completedClass =
              job.status === "completed" ? "completed" : "";

            return `
          <div class="job-card ${activeClass} ${completedClass}">
            <div class="job-header">
              <div>
                <div class="job-number">Job ${job.id.split("-")[1]}</div>
                <div class="job-time">${job.time}</div>
              </div>
              <div class="job-status ${job.status}">${job.status}</div>
            </div>
            
            <div class="client-info">
              <div class="client-name">üë§ ${job.client}</div>
              <div class="client-address">
                <span>üìç</span>
                <span>${job.address}<br>${job.city}</span>
              </div>
            </div>
            
            <div class="service-list">
              ${job.services
                .map(
                  (service) => `
                <div class="service-item">
                  <input type="checkbox" id="${job.id}-${service}" ${job.status === "completed" ? "checked disabled" : ""}>
                  <label for="${job.id}-${service}">${service}</label>
                </div>
              `
                )
                .join("")}
            </div>
            
            ${job.notes ? `<div class="card job-note"><strong>‚ö†Ô∏è Note:</strong> ${job.notes}</div>` : ""}
            
            <div class="job-actions">
              <button class="btn btn-navigate" onclick="navigateToJob('${job.address}, ${job.city}')">
                üß≠ Navigate
              </button>
              ${
                job.status !== "completed"
                  ? `
                <button class="btn btn-complete" onclick="openPhotoUpload('${job.id}')">
                  ‚úì Complete
                </button>
              `
                  : `
                <button class="btn btn-disabled-gray" disabled>
                  ‚úì Done
                </button>
              `
              }
            </div>
          </div>
        `;
          })
          .join("");
      }

      // Navigation
      function navigateToJob(address) {
        const encoded = encodeURIComponent(address);
        const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${encoded}`;
        const appleMapsUrl = `maps://maps.apple.com/?daddr=${encoded}`;

        // Try Apple Maps on iOS, Google Maps otherwise
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        window.location.href = isIOS ? appleMapsUrl : googleMapsUrl;
      }

      // Photo upload flow
      function openPhotoUpload(jobId) {
        currentJob = jobId;
        document.getElementById("photo-modal-title").textContent =
          `Upload Photos - ${jobId}`;
        document.getElementById("photo-modal").classList.add("active");
        document.body.style.overflow = "hidden";
      }

      function closePhotoUpload() {
        document.getElementById("photo-modal").classList.remove("active");
        document.body.style.overflow = "";
        document.getElementById("photo-preview").style.display = "none";
        document.getElementById("upload-photo-btn").style.display = "none";
        capturedPhoto = null;
      }

      function selectPhotoType(type) {
        photoType = type;
        document.querySelectorAll(".photo-type-btn").forEach((btn) => {
          btn.classList.toggle("selected", btn.dataset.type === type);
        });
      }

      function triggerCamera() {
        document.getElementById("photo-input").click();
      }

      // Handle photo selection
      document.getElementById("photo-input").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (evt) => {
          capturedPhoto = evt.target.result;
          const preview = document.getElementById("photo-preview");
          preview.innerHTML = `<img src="${evt.target.result}" alt="Photo preview">`;
          preview.style.display = "block";
          document.getElementById("upload-photo-btn").style.display = "block";
        };
        reader.readAsDataURL(file);
      });

      // Upload photo
      async function uploadPhoto() {
        if (!capturedPhoto || !currentJob) return;

        const btn = document.getElementById("upload-photo-btn");
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Uploading...';

        try {
          // Replace with actual API call
          await new Promise((resolve) => setTimeout(resolve, 1500));

          // Mark job as completed
          const job = jobsData.find((j) => j.id === currentJob);
          if (job) job.status = "completed";

          renderJobs(jobsData);
          closePhotoUpload();

          showMessage(
            "crew-status",
            `‚úì ${photoType === "before" ? "Before" : "After"} photo uploaded for ${currentJob}!`,
            "success",
            3000
          );
        } catch (err) {
          showMessage(
            "crew-status",
            "‚úó Upload failed. Please try again.",
            "error",
            5000
          );
        } finally {
          btn.disabled = false;
          btn.innerHTML = "üì§ Upload Photo";
        }
      }

      // Bottom nav handlers
      document.querySelectorAll(".nav-btn").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          document
            .querySelectorAll(".nav-btn")
            .forEach((b) => b.classList.remove("active"));
          e.currentTarget.classList.add("active");
        });
      });

      // Initial load
      loadCrewJobs();

      // Refresh every 5 minutes
      setInterval(loadCrewJobs, 300000);
    </script>
  </body>
</html>
