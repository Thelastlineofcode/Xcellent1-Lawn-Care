<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Xcellent1 Lawn Care owner dashboard - business KPIs, hiring metrics, revenue tracking"
    />
    <meta name="theme-color" content="#10b981" />
    <meta name="robots" content="noindex, nofollow" />
    <title>Business Dashboard | Xcellent1 Owner</title>
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon.ico" />
    <link rel="stylesheet" href="styles.clean.css" />
    <link rel="stylesheet" href="admin.css" />
  </head>
  <body>
    <nav class="navbar">
      <div class="navbar-brand">
        <img
          src="images/xcellent1-logo-transparent.png"
          alt="Xcellent1 logo"
          class="navbar-logo"
        />
        <div class="navbar-title">
          <span class="navbar-name">XCELLENT1</span>
          <span class="navbar-tagline">LAWN CARE</span>
        </div>
      </div>
      <div class="navbar-links">
        <a href="owner.html" class="navbar-link active">Dashboard</a>
        <a href="manage-clients.html" class="navbar-link">Clients</a>
        <a href="manage-jobs.html" class="navbar-link">Jobs</a>
        <a href="manage-invoices.html" class="navbar-link">Invoices</a>
        <a href="payment-accounts.html" class="navbar-link">Payments</a>
        <button onclick="logout()" class="btn btn-sm">Logout</button>
      </div>
    </nav>
    
    <!-- Load runtime config from server -->
    <script src="/config.js"></script>
    
    <!-- Authentication Check -->
    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2.39.0";

      // Use runtime-injected values when available, otherwise fall back to defaults
      const _env = (typeof window !== "undefined" && window.__ENV) || {};
      const SUPABASE_URL = _env.NEXT_PUBLIC_SUPABASE_URL || "https://utivthfrwgtjatsusopw.supabase.co";
      const SUPABASE_ANON_KEY = _env.NEXT_PUBLIC_SUPABASE_ANON_KEY || "YOUR_SUPABASE_ANON_KEY_HERE";

      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // Check authentication and role
      async function checkAuth() {
        const {
          data: { session },
        } = await supabase.auth.getSession();

        if (!session) {
          // Not logged in, redirect to login
          window.location.href = "login.html";
          return;
        }

        // Get user profile and verify role
        const { data: profile, error } = await supabase
          .from("users")
          .select("id, name, email, role, status")
          .eq("auth_user_id", session.user.id)
          .single();

        if (error || !profile || profile.role !== "owner") {
          // Invalid role or no profile, logout and redirect
          await supabase.auth.signOut();
          alert("Access denied. This page is only for owners.");
          window.location.href = "login.html";
          return;
        }

        if (profile.status !== "active") {
          await supabase.auth.signOut();
          alert("Your account is not active. Please contact support.");
          window.location.href = "login.html";
          return;
        }

        // Store user info and token for API calls
        window.userProfile = profile;
        window.supabaseSession = session;
        window.supabaseClient = supabase;

        // Update greeting
        const greeting = document.querySelector(".owner-greeting");
        if (greeting) {
          greeting.textContent = `Welcome back, ${profile.name}!`;
        }
      }

      // Run auth check immediately
      checkAuth();

      // Add logout handler
      window.logout = async function () {
        await supabase.auth.signOut();
        window.location.href = "login.html";
      };
    </script>

    <!-- Owner Header -->
    <div class="owner-header">
      <div class="container">
        <div class="owner-greeting">Business Dashboard</div>
        <div class="business-name">üå± Xcellent1 Lawn Care</div>
      </div>
    </div>

    <!-- Main Content -->
    <main class="container">
      <div id="owner-status" role="alert" aria-live="polite"></div>

      <!-- Key Business Metrics -->
      <section>
        <h2>Today's Snapshot</h2>
        <div class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-icon">üíµ</div>
            <div class="kpi-value" id="kpi-revenue">$0</div>
            <div class="kpi-label">This Month Revenue</div>
            <div class="kpi-trend up">
              <span>‚Üë</span>
              <span id="revenue-trend">+0%</span>
            </div>
          </div>

          <div class="kpi-card">
            <div class="kpi-icon">üë•</div>
            <div class="kpi-value" id="kpi-crew">0</div>
            <div class="kpi-label">Active Crew</div>
            <div class="kpi-trend" id="crew-trend"></div>
          </div>

          <div class="kpi-card">
            <div class="kpi-icon">‚úÖ</div>
            <div class="kpi-value" id="kpi-jobs">0</div>
            <div class="kpi-label">Jobs This Week</div>
            <div class="kpi-trend up">
              <span>‚Üë</span>
              <span id="jobs-trend">+0%</span>
            </div>
          </div>

          <div class="kpi-card">
            <div class="kpi-icon">üíº</div>
            <div class="kpi-value" id="kpi-applications">0</div>
            <div class="kpi-label">New Applications</div>
            <div class="kpi-trend" id="app-trend"></div>
          </div>

          <div class="kpi-card">
            <div class="kpi-icon">üìä</div>
            <div class="kpi-value" id="kpi-margin">0%</div>
            <div class="kpi-label">Profit Margin</div>
            <div class="kpi-trend" id="margin-trend"></div>
          </div>

          <div class="kpi-card">
            <div class="kpi-icon">üì∏</div>
            <div class="kpi-value" id="kpi-photos">0</div>
            <div class="kpi-label">Job Photos Today</div>
            <div class="kpi-trend"></div>
          </div>
        </div>
      </section>

      <!-- Quick Actions -->
      <section class="mb-lg">
        <h2>Quick Actions</h2>
        <div class="action-grid">
          <a href="manage-clients.html" class="action-card">
            <div class="action-icon">üë•</div>
            <div class="action-label">Manage Clients</div>
            <div class="action-count" id="action-clients">View all clients</div>
          </a>

          <a href="manage-jobs.html" class="action-card">
            <div class="action-icon">üìÖ</div>
            <div class="action-label">Schedule Jobs</div>
            <div class="action-count" id="action-jobs">Create & assign</div>
          </a>

          <a href="manage-invoices.html" class="action-card">
            <div class="action-icon">üí∞</div>
            <div class="action-label">Create Invoice</div>
            <div class="action-count" id="action-invoices">Billing & payments</div>
          </a>

          <a href="dashboard.html" class="action-card">
            <div class="action-icon">üíº</div>
            <div class="action-label">Review Applications</div>
            <div class="action-count" id="action-apps">Hiring dashboard</div>
          </a>

          <a href="manage-applications.html" class="action-card">
            <div class="action-icon">üìù</div>
            <div class="action-label">Manage Applications</div>
            <div class="action-count" id="action-manage-apps">Detailed review</div>
          </a>

          <a href="manage-waitlist.html" class="action-card">
            <div class="action-icon">üìã</div>
            <div class="action-label">Manage Waitlist</div>
            <div class="action-count" id="action-waitlist">Leads & inquiries</div>
          </a>

          <a href="payment-accounts.html" class="action-card">
            <div class="action-icon">üí≥</div>
            <div class="action-label">Payment Accounts</div>
            <div class="action-count" id="action-payment-accts">Setup & manage</div>
          </a>

          <a href="pending-payments.html" class="action-card">
            <div class="action-icon">‚è≥</div>
            <div class="action-label">Pending Payments</div>
            <div class="action-count" id="action-payments">Verify payments</div>
          </a>
        </div>
      </section>

      <!-- Alerts & Notifications -->
      <section class="mb-lg">
        <h2>Alerts & Priorities</h2>
        <div id="alerts-list">
          <!-- Dynamic alerts will be inserted here -->
        </div>
      </section>

      <!-- Revenue Chart -->
      <section class="mb-lg">
        <h2>Revenue Chart</h2>
        <div class="chart-card">
          <div class="chart-header">
            <div class="chart-title">üìà Revenue Trend</div>
            <div class="chart-period">Last 6 Months</div>
          </div>
          <div class="chart-placeholder">
            <div style="text-align: center">
              <div style="font-size: 2rem; margin-bottom: 0.5rem">üìâ</div>
              <div>Revenue chart loading...</div>
              <small class="text-muted">Chart.js integration coming soon</small>
            </div>
          </div>
        </div>
      </section>

      <!-- Hiring Pipeline -->
      <section class="mb-lg">
        <h2>Hiring Pipeline</h2>
        <div class="card">
          <div class="grid grid-2">
            <div>
              <h3>Applications</h3>
              <div
                style="
                  font-size: 2rem;
                  font-weight: 700;
                  color: var(--color-primary);
                "
                id="hiring-applications"
              >
                0
              </div>
              <p class="text-muted">This week</p>
            </div>
            <div>
              <h3>Interviews</h3>
              <div
                style="
                  font-size: 2rem;
                  font-weight: 700;
                  color: var(--color-primary);
                "
                id="hiring-interviews"
              >
                0
              </div>
              <p class="text-muted">Scheduled</p>
            </div>
            <div>
              <h3>Open Roles</h3>
              <div
                style="
                  font-size: 2rem;
                  font-weight: 700;
                  color: var(--color-warning);
                "
                id="hiring-openings"
              >
                0
              </div>
              <p class="text-muted">To fill</p>
            </div>
            <div>
              <h3>Retention</h3>
              <div
                style="
                  font-size: 2rem;
                  font-weight: 700;
                  color: var(--color-success);
                "
                id="hiring-retention"
              >
                0%
              </div>
              <p class="text-muted">90-day rate</p>
            </div>
          </div>
          <button
            class="btn mt-md"
            onclick="window.location.href='dashboard.html'"
          >
            üìÑ View All Applications
          </button>
        </div>
      </section>

      <!-- Crew Performance -->
      <section class="mb-lg">
        <h2>Crew Performance</h2>
        <div id="crew-list">
          <div class="loading-container">
            <span class="spinner"></span>
            <span>Loading crew data...</span>
          </div>
        </div>
      </section>

      <!-- Quote Calculator (Owner Only) -->
      <section class="mb-lg">
        <h2>Quote Calculator</h2>
        <form
          id="quote-form"
          action="#"
          style="
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: flex-end;
            margin-bottom: 1rem;
          "
        >
          <div
            class="quote-step"
            id="quote-step-1"
            style="flex: 1; min-width: 180px"
          >
            <label for="quote-address">Address</label>
            <input
              id="quote-address"
              name="address"
              class="form-field"
              placeholder="123 Main St, LaPlace, LA"
              required
            />
          </div>
          <div style="min-width: 120px">
            <label for="quote-size-1">Lawn Size (sqft)</label>
            <input
              id="quote-size-1"
              name="lawn_size"
              class="form-field"
              type="number"
              min="100"
              step="10"
              placeholder="e.g. 2500"
              required
            />
          </div>
          <div style="min-width: 180px">
            <label for="quote-service-1">Service</label>
            <select
              id="quote-service-1"
              name="service_type"
              class="form-select"
              required
            >
              <option value="" disabled selected>Select a service</option>
              <option value="weekly">Weekly Lawn Maintenance</option>
              <option value="flower-bed">Flower Bed Clean Out</option>
              <option value="spring-cleaning">Spring Cleaning</option>
              <option value="leaf-debris">Leaf & Debris Removal</option>
              <option value="tractor">Tractor / Bush Hog</option>
            </select>
          </div>
          <button
            type="button"
            class="waitlist-submit"
            style="margin-top: 0.5rem; width: 100%"
            onclick="showQuoteStep(2)"
          >
            Next
          </button>
          <div
            class="quote-step"
            id="quote-step-2"
            style="min-width: 120px; display: none"
          >
            <label for="quote-size-2">Lawn Size (sqft)</label>
            <input
              id="quote-size-2"
              name="lawn_size"
              class="form-field"
              type="number"
              min="100"
              step="10"
              placeholder="e.g. 2500"
              required
              autocomplete="off"
              inputmode="numeric"
              style="
                padding: 16px;
                border-radius: 12px;
                font-size: 1.15rem;
                min-height: 48px;
              "
            />
            <button
              type="button"
              class="waitlist-submit"
              style="margin-top: 0.5rem; width: 100%"
              onclick="showQuoteStep(3)"
            >
              Next
            </button>
          </div>
          <div
            class="quote-step"
            id="quote-step-3"
            style="min-width: 180px; display: none"
          >
            <label for="quote-service-3">Service</label>
            <select
              id="quote-service-3"
              name="service_type"
              class="form-select"
              required
              style="
                padding: 16px;
                border-radius: 12px;
                font-size: 1.15rem;
                min-height: 48px;
              "
            >
              <option value="" disabled selected>Select a service</option>
              <option value="weekly">Weekly Lawn Maintenance</option>
              <option value="flower-bed">Flower Bed Clean Out</option>
              <option value="spring-cleaning">Spring Cleaning</option>
              <option value="leaf-debris">Leaf & Debris Removal</option>
              <option value="tractor">Tractor / Bush Hog</option>
            </select>
            <button
              type="submit"
              class="waitlist-submit"
              style="margin-top: 0.5rem; width: 100%"
            >
              Get Estimate
            </button>
          </div>
        </form>
        <div
          id="quote-result"
          style="
            display: none;
            margin-top: 1rem;
            font-weight: 600;
            color: #059669;
          "
        ></div>
        <div id="service-area-map" style="margin-top: 2rem">
          <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem">
            Service Area: River Parishes
          </h3>
          <iframe
            title="River Parishes Service Area"
            height="320"
            style="border: 1px solid #ccc; border-radius: 12px; width: 100%"
            loading="lazy"
            allowfullscreen
            referrerpolicy="no-referrer-when-downgrade"
            src="https://www.google.com/maps/d/embed?mid=1Qn6Qw7Qw7Qw7Qw7Qw7Qw7Qw7Qw7Qw7Q&ehbc=2E312F"
          ></iframe>
          <div style="font-size: 0.95rem; color: #666; margin-top: 0.5rem">
            Covers St. John the Baptist, St. Charles, and St. James Parishes
            (LaPlace, Norco, Reserve, Luling, Lutcher, Gramercy, and more).
          </div>
        </div>
        <script>
          function showQuoteStep(step) {
            for (let i = 1; i <= 3; i++) {
              document.getElementById("quote-step-" + i).style.display =
                i === step ? "" : "none";
            }
          }
        </script>
      </section>

      <!-- Financial Summary -->
      <section>
        <h2>Financial Summary</h2>
        <div class="grid grid-2">
          <div class="card">
            <h3>üí∞ Accounts Receivable</h3>
            <div
              style="
                font-size: 1.75rem;
                font-weight: 700;
                color: var(--color-warning);
              "
              id="fin-ar"
            >
              $0
            </div>
            <p class="text-muted">Outstanding invoices</p>
            <button class="btn-secondary mt-sm full-width">View Details</button>
          </div>

          <div class="card">
            <h3>üìä Profit Margin</h3>
            <div
              style="
                font-size: 1.75rem;
                font-weight: 700;
                color: var(--color-success);
              "
              id="fin-margin"
            >
              0%
            </div>
            <p class="text-muted">This month (target: 50%)</p>
            <div
              class="progress-bar"
              style="
                height: 8px;
                background: var(--color-bg);
                border-radius: 4px;
                overflow: hidden;
                margin-top: 0.5rem;
              "
            >
              <div
                id="margin-bar"
                style="
                  height: 100%;
                  background: var(--color-success);
                  width: 0%;
                  transition: width 0.5s;
                "
              ></div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="text-center mt-lg text-muted">
      <p>&copy; 2025 Xcellent1 Lawn Care. All rights reserved.</p>
      <p><small>Owner Dashboard v1.0</small></p>
    </footer>

    <!-- JavaScript -->
    <script src="app.js"></script>
    <script>
      // Quote Calculator logic
      document.getElementById("quote-form").onsubmit = async function (e) {
        e.preventDefault();
        const form = e.target;
        const resultDiv = document.getElementById("quote-result");
        resultDiv.style.display = "none";
        resultDiv.textContent = "";
        resultDiv.style.color = "#059669";
        const data = Object.fromEntries(new FormData(form));
        try {
          // Get auth token
          const token = window.supabaseSession?.access_token;
          const res = await fetch("/api/v1/quotes/estimate", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(data),
          });
          const json = await res.json();
          if (json.ok) {
            resultDiv.style.display = "block";
            resultDiv.textContent = `Estimated Price: $${json.price_low} - $${json.price_high} (${json.notes || ""})`;
          } else if (json.error && json.error.includes("River Parishes")) {
            resultDiv.style.display = "block";
            resultDiv.style.color = "#b91c1c";
            resultDiv.innerHTML = `${json.error}<br><button id='collect-lead-btn' class='waitlist-submit' style='margin-top:0.75rem;'>Request Future Service</button>`;
            document.getElementById("collect-lead-btn").onclick = function () {
              resultDiv.innerHTML =
                "Thank you! We'll notify you if we expand to your area.";
              // Optionally, send the lead to a /api/leads endpoint for future expansion
              fetch("/api/leads", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  name: data.address,
                  type: "future-service",
                  details: data,
                }),
              });
            };
          } else {
            resultDiv.style.display = "block";
            resultDiv.style.color = "#b91c1c";
            resultDiv.textContent = json.error || "Could not calculate quote.";
          }
        } catch (err) {
          resultDiv.style.display = "block";
          resultDiv.style.color = "#b91c1c";
          resultDiv.textContent = "Error contacting server.";
        }
      };

      // Owner Dashboard Logic

      // Fetch owner metrics from API
      async function fetchOwnerMetrics() {
        try {
          const token = window.supabaseSession?.access_token;
          if (!token) {
            throw new Error("No authentication token");
          }

          const response = await fetch("/api/owner/metrics", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            throw new Error(`API error: ${response.status}`);
          }

          const data = await response.json();
          if (!data.ok) {
            throw new Error(data.error || "Failed to fetch metrics");
          }

          return data;
        } catch (err) {
          console.error("Failed to fetch owner metrics:", err);
          showMessage(
            "owner-status",
            "‚ö†Ô∏è Unable to load live metrics. Showing cached data.",
            "warning",
            5000
          );
          // Return fallback data
          return {
            ok: true,
            active_crew: 0,
            new_applications: 0,
            jobs_this_week: 0,
            photos_today: 0,
            total_clients: 0,
          };
        }
      }

      // Fetch crew performance from API
      async function fetchCrewPerformance() {
        try {
          const token = window.supabaseSession?.access_token;
          if (!token) {
            return [];
          }

          const response = await fetch("/api/owner/crew-performance", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            throw new Error(`API error: ${response.status}`);
          }

          const data = await response.json();
          return data.crew || [];
        } catch (err) {
          console.error("Failed to fetch crew performance:", err);
          return [];
        }
      }

      // Load owner dashboard
      async function loadOwnerDashboard() {
        const apiData = await fetchOwnerMetrics();
        const crewData = await fetchCrewPerformance();

        // Map API data to dashboard format (all metrics now from database)
        const data = {
          revenue_this_month: apiData.revenue_this_month || 0,
          revenue_last_month: apiData.revenue_last_month || 0,
          active_crew: apiData.active_crew || 0,
          jobs_this_week: apiData.jobs_this_week || 0,
          jobs_last_week: apiData.jobs_last_week || 0,
          new_applications: apiData.new_applications || 0,
          interviews_scheduled: apiData.interviews_scheduled || 0,
          open_positions: apiData.open_positions || 0,
          retention_90day: apiData.retention_90day || 100,
          profit_margin: apiData.profit_margin || 0,
          accounts_receivable: apiData.accounts_receivable || 0,
          photos_today: apiData.photos_today || 0,
          total_clients: apiData.total_clients || 0,
          revenue_growth_pct: apiData.revenue_growth_pct || 0,
          jobs_growth_pct: apiData.jobs_growth_pct || 0,
          crew_performance: crewData.map((c) => ({
            name: c.crew_name,
            role: "Field Worker",
            jobs: c.jobs_completed || 0,
            rating: c.avg_rating || 0,
            photos: c.photos_uploaded || 0,
          })),
        };

        // Revenue KPI
        document.getElementById("kpi-revenue").textContent =
          "$" + data.revenue_this_month.toLocaleString();
        const revGrowth = data.revenue_growth_pct;
        document.getElementById("revenue-trend").textContent =
          (revGrowth > 0 ? "+" : "") + revGrowth + "%";
        document.querySelector("#kpi-revenue").parentElement.querySelector(".kpi-trend").className =
          "kpi-trend " + (revGrowth >= 0 ? "up" : "down");

        // Crew KPI
        document.getElementById("kpi-crew").textContent = data.active_crew;
        document.getElementById("crew-trend").textContent =
          data.open_positions + " openings";
        document
          .getElementById("crew-trend")
          .classList.add(data.open_positions > 0 ? "down" : "up");

        // Jobs KPI
        document.getElementById("kpi-jobs").textContent = data.jobs_this_week;
        const jobGrowth = data.jobs_growth_pct;
        document.getElementById("jobs-trend").textContent =
          (jobGrowth > 0 ? "+" : "") + jobGrowth + "%";
        document.querySelector("#kpi-jobs").parentElement.querySelector(".kpi-trend").className =
          "kpi-trend " + (jobGrowth >= 0 ? "up" : "down");

        // Applications KPI
        document.getElementById("kpi-applications").textContent =
          data.new_applications;
        document.getElementById("app-trend").textContent = "This week";

        // Margin KPI
        document.getElementById("kpi-margin").textContent =
          data.profit_margin + "%";
        const marginStatus =
          data.profit_margin >= 50
            ? "up"
            : data.profit_margin >= 40
              ? ""
              : "down";
        document.getElementById("margin-trend").textContent =
          data.profit_margin >= 50 ? "On target" : "Below target";
        if (marginStatus)
          document.getElementById("margin-trend").classList.add(marginStatus);

        // Photos KPI
        document.getElementById("kpi-photos").textContent = data.photos_today;

        // Action counts
        document.getElementById("action-apps").textContent =
          data.new_applications + " pending";
        document.getElementById("action-routes").textContent =
          data.active_crew + " crew";
        document.getElementById("action-clients").textContent =
          data.total_clients + " accounts";

        // Financial
        document.getElementById("fin-ar").textContent =
          "$" + data.accounts_receivable.toLocaleString();
        document.getElementById("fin-margin").textContent =
          data.profit_margin + "%";
        document.getElementById("margin-bar").style.width =
          data.profit_margin + "%";

        // Hiring metrics
        document.getElementById("hiring-applications").textContent =
          data.new_applications;
        document.getElementById("hiring-interviews").textContent =
          data.interviews_scheduled;
        document.getElementById("hiring-openings").textContent =
          data.open_positions;
        document.getElementById("hiring-retention").textContent =
          data.retention_90day + "%";

        // Generate dynamic alerts based on data
        const alerts = [];

        // Revenue alert
        if (data.revenue_growth_pct > 0) {
          alerts.push({
            type: "success",
            icon: "üí∞",
            message: `Revenue up ${data.revenue_growth_pct}% from last month ($${data.revenue_this_month.toLocaleString()})`,
            action: "View Details",
            link: "#",
          });
        } else if (data.revenue_growth_pct < -10) {
          alerts.push({
            type: "warning",
            icon: "‚ö†Ô∏è",
            message: `Revenue down ${Math.abs(data.revenue_growth_pct)}% from last month`,
            action: "Review Metrics",
            link: "#",
          });
        }

        // Applications alert
        if (data.new_applications > 0) {
          alerts.push({
            type: "success",
            icon: "‚úÖ",
            message: `${data.new_applications} new application${data.new_applications > 1 ? "s" : ""} to review`,
            action: "View Applications",
            link: "dashboard.html",
          });
        }

        // Jobs alert
        if (data.jobs_this_week > 0) {
          alerts.push({
            type: "success",
            icon: "üö©",
            message: `${data.jobs_this_week} jobs scheduled this week`,
            action: "View Schedule",
            link: "#",
          });
        }

        // Accounts receivable alert
        if (data.accounts_receivable > 0) {
          alerts.push({
            type: "warning",
            icon: "üíµ",
            message: `$${data.accounts_receivable.toLocaleString()} in outstanding invoices`,
            action: "Follow Up",
            link: "#",
          });
        }

        // Client growth
        if (data.total_clients > 0) {
          alerts.push({
            type: "success",
            icon: "üë•",
            message: `Serving ${data.total_clients} active clients`,
            action: "View Clients",
            link: "#",
          });
        }

        // Render alerts
        renderAlerts(alerts);

        // Render crew performance (empty for now until we add the endpoint)
        renderCrewPerformance(data.crew_performance);
      }

      // Render alerts
      function renderAlerts(alerts) {
        const container = document.getElementById("alerts-list");
        if (alerts.length === 0) {
          container.innerHTML =
            '<div class="card alert-card success"><p>‚úÖ No alerts. Business is running smoothly!</p></div>';
          return;
        }

        container.innerHTML = alerts
          .map(
            (alert) => `
        <div class="card alert-card ${alert.type} mb-md">
          <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
            <div style="flex: 1;">
              <div style="font-weight: 600; margin-bottom: 0.5rem;">${alert.icon} ${alert.message}</div>
            </div>
            <a href="${alert.link}" class="btn-secondary" style="white-space: nowrap;">${alert.action}</a>
          </div>
        </div>
      `
          )
          .join("");
      }

      // Render crew performance
      function renderCrewPerformance(crew) {
        const container = document.getElementById("crew-list");
        if (crew.length === 0) {
          container.innerHTML =
            '<div class="empty-state"><p class="text-muted">No active crew members.</p></div>';
          return;
        }

        container.innerHTML = crew
          .map(
            (member) => `
        <div class="card mb-md">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
              <h3>üë§ ${member.name}</h3>
              <p class="text-muted" style="font-size: 0.875rem; margin: 0.25rem 0;">${member.role}</p>
              <div style="display: flex; gap: 1rem; margin-top: 0.75rem; font-size: 0.875rem;">
                <span>üö© ${member.jobs} jobs</span>
                <span>‚≠ê ${member.rating}/5.0</span>
                <span>üì∏ ${member.photos} photos</span>
              </div>
            </div>
            <span class="badge badge-primary">Active</span>
          </div>
        </div>
      `
          )
          .join("");
      }

      // Initial load
      loadOwnerDashboard();

      // Auto-refresh every 60 seconds
      setInterval(loadOwnerDashboard, 60000);
    </script>
  </body>
</html>
