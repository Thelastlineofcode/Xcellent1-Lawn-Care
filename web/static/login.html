<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Sign in to your Xcellent1 Lawn Care account. Access owner dashboard, crew portal, or customer account."
    />
    <meta name="theme-color" content="#3b832a" />
    <meta name="robots" content="noindex, nofollow" />
    <title>Login | Xcellent1 Lawn Care</title>
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon.ico" />
    <link rel="stylesheet" href="styles.clean.css" />
    <style>
      .login-page {
        background: linear-gradient(135deg, #3b832a 0%, #2d6520 100%);
        min-height: calc(100vh - 70px);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
      }

      .login-container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 420px;
        width: 100%;
        padding: 48px 40px;
      }

      .login-logo {
        text-align: center;
        margin-bottom: 32px;
      }

      .login-logo h1 {
        color: #3b832a;
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 8px;
      }

      .login-logo p {
        color: #666;
        font-size: 14px;
      }

      .login-form-group {
        margin-bottom: 24px;
      }

      .login-form-group label {
        display: block;
        color: #333;
        font-weight: 500;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .login-form-group input[type="email"],
      .login-form-group input[type="password"] {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 15px;
        transition: border-color 0.3s;
      }

      .login-form-group input:focus {
        outline: none;
        border-color: #3b832a;
      }

      .login-btn {
        width: 100%;
        padding: 14px;
        background: #3b832a;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s;
      }

      .login-btn:hover {
        background: #2d6520;
      }

      .login-btn:disabled {
        background: #cccccc;
        cursor: not-allowed;
      }

      .error-message {
        background: #fee;
        border: 1px solid #fcc;
        color: #c33;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 14px;
        display: none;
      }

      .error-message.show {
        display: block;
      }

      .forgot-password {
        text-align: center;
        margin-top: 16px;
      }

      .forgot-password a {
        color: #3b832a;
        text-decoration: none;
        font-size: 14px;
      }

      .forgot-password a:hover {
        text-decoration: underline;
      }

      .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #ffffff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 0.8s linear infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .footer-text {
        text-align: center;
        margin-top: 24px;
        color: #666;
        font-size: 13px;
      }
    </style>
  </head>

  <body>
    <nav class="navbar">
      <div class="navbar-brand">
        <img
          src="images/xcellent1-logo-transparent.png"
          alt="Xcellent1 logo"
          class="navbar-logo"
        />
        <div class="navbar-title">
          <span class="navbar-name">XCELLENT1</span>
          <span class="navbar-tagline">LAWN CARE</span>
        </div>
      </div>
      <div class="navbar-links">
        <a href="home.html" class="navbar-link">Home</a>
        <a href="home.html#services" class="navbar-link">Services</a>
        <a href="careers.html" class="navbar-link">Careers</a>
      </div>
    </nav>

    <div class="login-page">
      <div class="login-container">
        <div class="login-logo">
          <h1>Xcellent1 Lawn Care</h1>
          <p>Sign in to your account</p>
        </div>

        <div id="error-message" class="error-message"></div>

        <form id="login-form" action="#">
          <div class="login-form-group">
            <label for="email">Email Address</label>
            <input
              type="email"
              id="email"
              name="email"
              placeholder="you@example.com"
              required
              autocomplete="email"
            />
          </div>

          <div class="login-form-group">
            <label for="password">Password</label>
            <input
              type="password"
              id="password"
              name="password"
              placeholder="Enter your password"
              required
              autocomplete="current-password"
            />
          </div>

          <button type="submit" class="login-btn" id="login-btn">
            Sign In
          </button>
        </form>

        <div class="forgot-password">
          <a href="#" id="forgot-password-link">Forgot your password?</a>
        </div>

        <div class="footer-text">Secure login powered by Supabase</div>
      </div>
    </div>

    <footer class="footer">
      <div class="footer-content">
        <div class="footer-brand">
          <img
            src="images/xcellent1-logo-transparent.png"
            alt="Xcellent1 logo"
            class="footer-logo"
          />
          <div>
            <p class="footer-name">XCELLENT1 LAWN CARE</p>
            <p class="footer-tagline">
              Precision Lawn Care for the River Parishes
            </p>
          </div>
        </div>
        <div class="footer-links">
          <a href="home.html">Home</a>
          <a href="home.html#services">Services</a>
          <a href="careers.html">Careers</a>
        </div>
        <p class="footer-copy">
          Â© 2025 Xcellent1 Lawn Care LLC. All rights reserved.
        </p>
      </div>
    </footer>

    <!-- Runtime config for client-side (injected by server at /config.js) -->
    <script src="/config.js"></script>
    <!-- Supabase Client -->
    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2.39.0";

      // Initialize Supabase client using runtime values when available
      const _env = typeof window !== "undefined"
        ? window.__ENV || {}
        : {};
      const SUPABASE_URL = _env.NEXT_PUBLIC_SUPABASE_URL ||
        "https://utivthfrwgtjatsusopw.supabase.co";
      const SUPABASE_ANON_KEY = _env.NEXT_PUBLIC_SUPABASE_ANON_KEY ||
        "YOUR_SUPABASE_ANON_KEY_HERE";

      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const loginForm = document.getElementById("login-form");
      const loginBtn = document.getElementById("login-btn");
      const errorMessage = document.getElementById("error-message");
      const forgotPasswordLink = document.getElementById(
        "forgot-password-link",
      );

      // Check if user is already logged in
      async function checkAuth() {
        try {
          const {
            data: { session },
          } = await supabase.auth.getSession();

          if (session) {
            // User is already logged in, redirect to appropriate dashboard
            await redirectToDashboard(session.user);
          }
        } catch (error) {
          // Silently fail - user just isn't logged in
          console.log("No active session");
        }
      }

      // Handle login
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;

        // Disable button and show loading
        loginBtn.disabled = true;
        loginBtn.innerHTML =
          '<span class="loading"></span>Signing in...';
        errorMessage.classList.remove("show");

        try {
          // Sign in with Supabase
          const { data, error } = await supabase.auth
            .signInWithPassword({
              email: email,
              password: password,
            });

          if (error) throw error;

          // Get user profile to determine role
          const { data: profile, error: profileError } = await supabase
            .from("users")
            .select("id, name, email, role, auth_user_id")
            .eq("auth_user_id", data.user.id)
            .single();

          if (profileError) {
            throw new Error(
              "Account not found. Please contact support.",
            );
          }

          // Store user info for easy access
          localStorage.setItem("user_profile", JSON.stringify(profile));

          // Redirect based on role
          await redirectToDashboard(data.user, profile.role);
        } catch (error) {
          console.error("Login error:", error);
          errorMessage.textContent = error.message ||
            "Invalid email or password";
          errorMessage.classList.add("show");

          // Re-enable button
          loginBtn.disabled = false;
          loginBtn.innerHTML = "Sign In";
        }
      });

      // Redirect to appropriate dashboard based on role
      async function redirectToDashboard(user, role) {
        if (!role) {
          // If role not provided, fetch from database
          try {
            const { data: profile, error } = await supabase
              .from("users")
              .select("role")
              .eq("auth_user_id", user.id)
              .single();

            if (error) {
              console.error("Error fetching role:", error);
              // Sign out and show error
              await supabase.auth.signOut();
              errorMessage.textContent =
                "Unable to determine account type. Please contact support.";
              errorMessage.classList.add("show");
              return;
            }

            role = profile?.role;
          } catch (error) {
            console.error("Error in redirectToDashboard:", error);
            await supabase.auth.signOut();
            return;
          }
        }

        switch (role) {
          case "owner":
            window.location.href = "owner.html";
            break;
          case "crew":
            window.location.href = "crew.html";
            break;
          case "client":
            window.location.href = "client.html";
            break;
          default:
            errorMessage.textContent =
              "Invalid user role. Please contact support.";
            errorMessage.classList.add("show");
            loginBtn.disabled = false;
            loginBtn.innerHTML = "Sign In";
        }
      }

      // Handle forgot password
      forgotPasswordLink.addEventListener("click", async (e) => {
        e.preventDefault();

        const email = document.getElementById("email").value;

        if (!email) {
          alert("Please enter your email address first");
          return;
        }

        try {
          const { error } = await supabase.auth.resetPasswordForEmail(
            email,
            {
              redirectTo:
                `${window.location.origin}/reset-password.html`,
            },
          );

          if (error) throw error;

          alert("Password reset email sent! Please check your inbox.");
        } catch (error) {
          console.error("Password reset error:", error);
          alert("Error sending password reset email: " + error.message);
        }
      });

      // Check auth on page load
      checkAuth();
    </script>
  </body>
</html>
