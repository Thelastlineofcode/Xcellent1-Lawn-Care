<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Xcellent1 Lawn Care customer portal - view service history, job photos, and manage account"
    />
    <meta name="theme-color" content="#10b981" />
    <title>My Account | Xcellent1 Lawn Care</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="admin.css" />
  </head>
  <body>
    <nav class="navbar">
      <div class="navbar-brand">
        <img src="images/xcellent1-logo-transparent.png" alt="Xcellent1 logo" class="navbar-logo" />
        <div class="navbar-title">
          <span class="navbar-name">XCELLENT1</span>
          <span class="navbar-tagline">LAWN CARE</span>
        </div>
      </div>
      <div class="navbar-links">
        <a href="home.html" class="navbar-link">Home</a>
        <a href="shop.html" class="navbar-link">Shop</a>
        <a href="careers.html" class="navbar-link">Careers</a>
        <a href="login.html" class="navbar-login">Login</a>
      </div>
    </nav>

    <!-- Client Header -->
    <div class="client-header">
      <div class="container">
        <div class="client-name" id="client-name">Loading...</div>
        <div class="client-property">
          <span>üìç</span>
          <span id="client-address">Loading...</span>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <main class="container">
      <!-- Account Status Messages -->
      <div id="client-status" role="alert" aria-live="polite"></div>

      <!-- Invoice Summary -->
      <section class="mb-lg">
        <h2>Account Summary</h2>
        <div class="invoice-summary">
          <div class="invoice-stat">
            <div class="invoice-stat-value" id="stat-balance">$0</div>
            <div class="invoice-stat-label">Current Balance</div>
          </div>
          <div class="invoice-stat">
            <div class="invoice-stat-value" id="stat-services">0</div>
            <div class="invoice-stat-label">Services This Month</div>
          </div>
          <div class="invoice-stat">
            <div class="invoice-stat-value" id="stat-photos">0</div>
            <div class="invoice-stat-label">Photos Available</div>
          </div>
        </div>
      </section>

      <!-- Recent Job Photos -->
      <section class="mb-lg">
        <div class="card-header">
          <h2>üì∏ Before & After Photos</h2>
          <p class="text-muted">
            See the results from your recent lawn services. Tap any photo to
            view full size.
          </p>
        </div>
        <div id="photo-gallery" class="photo-gallery">
          <div class="loading-container">
            <span class="spinner"></span>
            <span>Loading photos...</span>
          </div>
        </div>
      </section>

      <!-- Service History -->
      <section class="mb-lg">
        <h2>Service History</h2>
        <div id="service-history">
          <div class="loading-container">
            <span class="spinner"></span>
            <span>Loading history...</span>
          </div>
        </div>
      </section>

      <!-- Payment Section -->
      <section class="card">
        <h2>üí≥ Make a Payment</h2>
        <p class="text-muted mb-md">
          Choose your preferred payment method. Tap to open app or copy payment
          details.
        </p>

        <div id="payment-status" role="alert" aria-live="polite"></div>

        <!-- Payment Amount Input -->
        <div class="form-group">
          <label for="payment-amount">
            Amount to Pay
            <span class="required">*</span>
          </label>
          <input
            type="number"
            id="payment-amount"
            name="amount"
            min="0"
            step="0.01"
            placeholder="0.00"
            required
            readonly
            style="
              font-size: 1.25rem;
              font-weight: 700;
              color: var(--color-primary);
            "
          />
          <small class="text-muted">Current balance due</small>
        </div>

        <!-- Payment Options -->
        <div class="payment-options">
          <!-- Cash App -->
          <a
            href="#"
            class="payment-option"
            id="cashapp-btn"
            onclick="handleCashApp(event)"
          >
            <div class="payment-icon">üíµ</div>
            <div class="payment-label">Cash App</div>
            <div class="payment-handle">$Xcellent1Lawn</div>
          </a>

          <!-- Zelle -->
          <a
            href="#"
            class="payment-option"
            id="zelle-btn"
            onclick="handleZelle(event)"
          >
            <div class="payment-icon">üè¶</div>
            <div class="payment-label">Zelle</div>
            <div class="payment-handle">pay@xcellent1.com</div>
          </a>

          <!-- PayPal -->
          <a
            href="https://www.paypal.com/paypalme/Xcellent1Lawn"
            target="_blank"
            class="payment-option"
            id="paypal-btn"
          >
            <div class="payment-icon">üîµ</div>
            <div class="payment-label">PayPal</div>
            <div class="payment-handle">@Xcellent1Lawn</div>
          </a>

          <!-- Traditional Card (Future) -->
          <a
            href="#"
            class="payment-option"
            onclick="handleCard(event)"
            style="opacity: 0.5; cursor: not-allowed"
          >
            <div class="payment-icon">üí≥</div>
            <div class="payment-label">Credit Card</div>
            <div class="payment-handle">Coming Soon</div>
          </a>
        </div>

        <!-- Payment Instructions -->
        <div
          class="card"
          style="
            background: var(--color-bg);
            border: 1px solid var(--color-border);
          "
        >
          <h3>Payment Instructions</h3>
          <ol style="padding-left: 1.5rem; margin: 0.5rem 0">
            <li class="mb-sm">Tap your preferred payment method above</li>
            <li class="mb-sm">
              Send the amount shown (or your preferred amount)
            </li>
            <li class="mb-sm">
              Include your name in the note/memo:
              <strong id="payment-memo">Sarah Martinez - 123 Oak St</strong>
            </li>
            <li>We'll update your balance within 24 hours</li>
          </ol>
          <p class="text-muted mt-md">
            <small
              >üîí Secure: We never store payment credentials. All transactions
              processed through trusted payment providers.</small
            >
          </p>
        </div>

        <!-- Mark as Paid Button -->
        <div id="mark-paid-container" style="margin-top: 20px; display: none;">
          <button
            id="mark-paid-btn"
            class="btn btn-primary"
            onclick="showMarkPaidModal()"
            style="width: 100%; padding: 15px; font-size: 16px; font-weight: 600;"
          >
            ‚úì I've Sent Payment - Mark as Paid
          </button>
          <p class="text-muted mt-sm" style="text-align: center; font-size: 13px;">
            Click after sending payment to update your balance
          </p>
        </div>
      </section>
    </main>

    <!-- Photo Modal -->
    <div id="photo-modal" class="modal">
      <div class="modal-content">
        <button class="modal-close" onclick="closePhotoModal()">&times;</button>
        <button class="modal-nav modal-prev" onclick="prevPhoto()">‚Äπ</button>
        <img
          id="modal-image"
          class="modal-image"
          src="images/xcellent1-logo-small.png"
          alt="Job photo"
        />
        <div class="modal-info" id="modal-info">
          <strong id="modal-title">Before Photo</strong>
          <div id="modal-date">Nov 5, 2025</div>
        </div>
        <button class="modal-nav modal-next" onclick="nextPhoto()">‚Ä∫</button>
      </div>
    </div>

    <!-- Mark as Paid Modal -->
    <div id="mark-paid-modal" class="modal" style="display: none;">
      <div class="modal-content" style="max-width: 500px; background: white; border-radius: 12px; padding: 0;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 20px;">Mark Payment as Sent</h2>
          <button onclick="closeMarkPaidModal()" style="background: none; border: none; color: white; font-size: 28px; cursor: pointer; line-height: 1; padding: 0;">&times;</button>
        </div>
        <div style="padding: 30px;">
          <p style="margin-bottom: 20px; color: #666;">
            Confirm the details of your payment so we can update your balance.
          </p>
          <form id="mark-paid-form">
            <div class="form-group">
              <label for="paid-payment-method" style="display: block; margin-bottom: 8px; font-weight: 600;">
                Payment Method <span style="color: #dc3545;">*</span>
              </label>
              <select id="paid-payment-method" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                <option value="">Select payment method...</option>
                <option value="cash_app">Cash App</option>
                <option value="zelle">Zelle</option>
                <option value="paypal">PayPal</option>
                <option value="cash">Cash</option>
                <option value="check">Check</option>
              </select>
            </div>
            <div class="form-group" style="margin-top: 20px;">
              <label for="paid-transaction-id" style="display: block; margin-bottom: 8px; font-weight: 600;">
                Transaction ID / Confirmation Number
              </label>
              <input
                type="text"
                id="paid-transaction-id"
                placeholder="Optional - e.g., #123ABC456"
                style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"
              />
              <small style="color: #999; font-size: 12px;">
                Include if you have a confirmation number from your payment app
              </small>
            </div>
            <div class="form-group" style="margin-top: 20px;">
              <label for="paid-notes" style="display: block; margin-bottom: 8px; font-weight: 600;">
                Notes (Optional)
              </label>
              <textarea
                id="paid-notes"
                rows="3"
                placeholder="Any additional information..."
                style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"
              ></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 25px;">
              <button
                type="submit"
                class="btn btn-primary"
                style="flex: 1; padding: 12px; font-size: 16px; font-weight: 600; border-radius: 8px; border: none; cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;"
              >
                Confirm Payment
              </button>
              <button
                type="button"
                onclick="closeMarkPaidModal()"
                class="btn btn-secondary"
                style="flex: 1; padding: 12px; font-size: 16px; font-weight: 600; border-radius: 8px; border: none; cursor: pointer; background: #6c757d; color: white;"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="text-center mt-lg text-muted">
      <p>&copy; 2025 Xcellent1 Lawn Care. All rights reserved.</p>
      <p><small>Need help? Call us: (555) 867-5309</small></p>
    </footer>

    <!-- JavaScript -->
    <script src="app.js"></script>
    <script type="module">
      import { requireAuth, logout } from "auth-helper.js";

      // Require client authentication
      const userProfile = await requireAuth("client", "#client-name");

      // Export for use in other scripts
      window.clientProfile = userProfile;
    </script>
    <script>
      // Client Portal Logic
      let CLIENT_ID = null; // Will be fetched from database
      let allPhotos = [];
      let currentPhotoIndex = 0;
      let clientData = null;

      // Payment provider handles (replace with your actual accounts)
      const PAYMENT_CONFIG = {
        cashapp: "$Xcellent1Lawn",
        zelle: "pay@xcellent1.com",
        paypal: "Xcellent1Lawn",
      };

      // Get client_id for the authenticated user
      async function getClientId() {
        try {
          const token = window.supabaseSession?.access_token;
          const userId = window.clientProfile?.id;

          if (!token || !userId) {
            throw new Error("No authentication");
          }

          // Query clients table to get client_id for this user
          const { data, error } = await window.supabaseClient
            .from("clients")
            .select("id")
            .eq("user_id", userId)
            .single();

          if (error || !data) {
            throw new Error("Client profile not found");
          }

          return data.id;
        } catch (err) {
          console.error("Failed to get client ID:", err);
          showMessage(
            "client-status",
            "‚ö†Ô∏è Unable to load your client profile. Please contact support.",
            "error",
            0
          );
          return null;
        }
      }

      // Fetch client dashboard data from API
      async function fetchClientDashboard(clientId) {
        try {
          const token = window.supabaseSession?.access_token;
          if (!token) {
            throw new Error("No authentication token");
          }

          const response = await fetch(`/api/client/${clientId}/dashboard`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            throw new Error(`API error: ${response.status}`);
          }

          const data = await response.json();
          if (!data.ok) {
            throw new Error(data.error || "Failed to fetch dashboard");
          }

          return data;
        } catch (err) {
          console.error("Failed to fetch client dashboard:", err);
          showMessage(
            "client-status",
            "‚ö†Ô∏è Unable to load dashboard data. Please refresh the page.",
            "warning",
            5000
          );
          // Return empty data as fallback
          return {
            ok: true,
            client: { name: "Client", address: "" },
            balance_due: 0,
            recent_jobs: [],
            photos: [],
          };
        }
      }

      // Fetch client data
      async function loadClientData() {
        try {
          // Get client_id first
          CLIENT_ID = await getClientId();
          if (!CLIENT_ID) {
            return; // Error already shown
          }

          // Fetch dashboard data
          const apiData = await fetchClientDashboard(CLIENT_ID);

          // Transform API data to match UI expectations
          clientData = {
            name: apiData.client?.name || "Client",
            address: apiData.client?.address || "",
            balance: apiData.balance_due || 0,
            services_this_month: apiData.recent_jobs?.length || 0,
            photos: (apiData.photos || []).map((photo) => ({
              id: photo.id,
              job_id: photo.job_id || "",
              type: photo.photo_type || "before",
              date: photo.job_date || new Date().toISOString(),
              url: photo.photo_url || "",
            })),
            service_history: (apiData.recent_jobs || []).map((job) => ({
              date: job.scheduled_date,
              services:
                typeof job.services === "string"
                  ? job.services.split(",")
                  : Array.isArray(job.services)
                    ? job.services
                    : [],
              status: job.status || "completed",
              photos: 0, // TODO: Count photos for this job
            })),
          };

          // Update UI
          document.getElementById("client-name").textContent = clientData.name;
          document.getElementById("client-address").textContent =
            clientData.address;
          document.getElementById("stat-balance").textContent =
            "$" + clientData.balance.toFixed(2);
          document.getElementById("stat-services").textContent =
            clientData.services_this_month;
          document.getElementById("stat-photos").textContent =
            clientData.photos.length;
          document.getElementById("payment-amount").value =
            clientData.balance.toFixed(2);
          document.getElementById("payment-memo").textContent =
            clientData.name + " - " + clientData.address.split(",")[0];

          allPhotos = clientData.photos;
          renderPhotoGallery(clientData.photos);
          renderServiceHistory(clientData.service_history);

          // Show/hide mark as paid button based on balance
          const markPaidContainer = document.getElementById("mark-paid-container");
          if (clientData.balance > 0) {
            markPaidContainer.style.display = "block";
            // Fetch invoices for this client
            await fetchClientInvoices();
          } else {
            markPaidContainer.style.display = "none";
          }
        } catch (err) {
          console.error("Failed to load client data:", err);
          showMessage(
            "client-status",
            "Failed to load account data. Please refresh.",
            "error"
          );
        }
      }

      // Fetch client invoices
      async function fetchClientInvoices() {
        try {
          const response = await fetch(`${API_BASE}/api/client/invoices`, {
            headers: {
              Authorization: `Bearer ${session.access_token}`,
            },
          });

          if (response.ok) {
            const data = await response.json();
            currentInvoices = data.invoices || [];
          }
        } catch (error) {
          console.error("Error fetching invoices:", error);
          // Non-critical error, don't show to user
        }
      }

      // Render photo gallery
      function renderPhotoGallery(photos) {
        const gallery = document.getElementById("photo-gallery");
        if (photos.length === 0) {
          gallery.innerHTML =
            '<div class="empty-state"><p class="text-muted">üèûÔ∏è No photos yet. Your crew will upload before/after photos after each service!</p></div>';
          return;
        }

        gallery.innerHTML = photos
          .map(
            (photo, index) => `
        <div class="photo-card" onclick="openPhotoModal(${index})">
          <img src="${photo.url}" alt="${photo.type} photo from ${new Date(photo.date).toLocaleDateString()}" loading="lazy">
          <div class="photo-badge ${photo.type}">${photo.type}</div>
        </div>
      `
          )
          .join("");
      }

      // Render service history
      function renderServiceHistory(history) {
        const container = document.getElementById("service-history");
        if (history.length === 0) {
          container.innerHTML =
            '<div class="empty-state"><p class="text-muted">No service history yet.</p></div>';
          return;
        }

        container.innerHTML = history
          .map(
            (job) => `
        <div class="card job-history-card mb-md">
          <div class="card-header">
            <h3 class="card-title">üìÖ ${new Date(job.date).toLocaleDateString("en-US", { weekday: "short", month: "short", day: "numeric" })}</h3>
            <span class="badge badge-primary">‚úì ${job.status}</span>
          </div>
          <div class="card-body">
            <div>
              ${job.services.map((s) => `<span class="service-badge">${s}</span>`).join("")}
            </div>
            ${job.photos > 0 ? `<p class="text-muted mt-sm"><small>üì∏ ${job.photos} photos - <a href="#" onclick="scrollToPhotos(event)">View Gallery ‚Üë</a></small></p>` : '<p class="text-muted mt-sm"><small>‚ö†Ô∏è No photos for this service</small></p>'}
          </div>
        </div>
      `
          )
          .join("");
      }

      // Photo modal functions
      function openPhotoModal(index) {
        currentPhotoIndex = index;
        updateModalPhoto();
        document.getElementById("photo-modal").classList.add("active");
        document.body.style.overflow = "hidden";
      }

      function updateModalPhoto() {
        const photo = allPhotos[currentPhotoIndex];
        document.getElementById("modal-image").src = photo.url;
        document.getElementById("modal-title").textContent =
          photo.type.charAt(0).toUpperCase() + photo.type.slice(1) + " Photo";
        document.getElementById("modal-date").textContent = new Date(
          photo.date
        ).toLocaleDateString("en-US", {
          month: "long",
          day: "numeric",
          year: "numeric",
        });
      }

      function closePhotoModal() {
        document.getElementById("photo-modal").classList.remove("active");
        document.body.style.overflow = "";
      }

      function prevPhoto() {
        currentPhotoIndex =
          (currentPhotoIndex - 1 + allPhotos.length) % allPhotos.length;
        updateModalPhoto();
      }

      function nextPhoto() {
        currentPhotoIndex = (currentPhotoIndex + 1) % allPhotos.length;
        updateModalPhoto();
      }

      function scrollToPhotos(e) {
        e.preventDefault();
        document
          .getElementById("photo-gallery")
          .scrollIntoView({ behavior: "smooth", block: "start" });
      }

      // Close modal on escape or click outside
      document.getElementById("photo-modal").addEventListener("click", (e) => {
        if (e.target.id === "photo-modal") closePhotoModal();
      });
      document.addEventListener("keydown", (e) => {
        const modal = document.getElementById("photo-modal");
        if (!modal.classList.contains("active")) return;
        if (e.key === "Escape") closePhotoModal();
        if (e.key === "ArrowLeft") prevPhoto();
        if (e.key === "ArrowRight") nextPhoto();
      });

      // Payment handlers
      function handleCashApp(e) {
        e.preventDefault();
        const amount = document.getElementById("payment-amount").value;
        const memo = encodeURIComponent(clientData.name + " - Lawn Care");

        // Try to open Cash App with deep link
        const cashAppUrl = `https://cash.app/${PAYMENT_CONFIG.cashapp}/${amount}?note=${memo}`;
        window.location.href = cashAppUrl;

        showMessage(
          "payment-status",
          `üíµ Opening Cash App...<br><small>Send <strong>$${amount}</strong> to <strong>${PAYMENT_CONFIG.cashapp}</strong></small>`,
          "info",
          8000
        );

        // Fallback: copy to clipboard
        navigator.clipboard.writeText(PAYMENT_CONFIG.cashapp).then(() => {
          console.log("Cash App handle copied to clipboard");
        });
      }

      function handleZelle(e) {
        e.preventDefault();
        const amount = document.getElementById("payment-amount").value;

        // Zelle doesn't have deep links - show instructions
        showMessage(
          "payment-status",
          `üè¶ <strong>Pay with Zelle:</strong><br><br>
        1. Open your banking app<br>
        2. Select Zelle<br>
        3. Send <strong>$${amount}</strong> to: <strong>${PAYMENT_CONFIG.zelle}</strong><br>
        4. Add note: "${clientData.name} - Lawn Care"<br><br>
        <button class="btn btn-sm" onclick="copyZelle()">üìã Copy Email</button>`,
          "info",
          0
        );
      }

      function copyZelle() {
        navigator.clipboard.writeText(PAYMENT_CONFIG.zelle).then(() => {
          showMessage(
            "payment-status",
            "‚úì Zelle email copied to clipboard!",
            "success",
            3000
          );
        });
      }

      function handleCard(e) {
        e.preventDefault();
        showMessage(
          "payment-status",
          "Credit card payments coming soon! Please use Cash App, Zelle, or PayPal.",
          "warning",
          5000
        );
      }

      // Mark as Paid handlers
      let currentInvoices = [];

      function showMarkPaidModal() {
        const balance = parseFloat(document.getElementById("payment-amount").value);
        if (balance <= 0) {
          showMessage("payment-status", "No balance due", "warning", 3000);
          return;
        }
        document.getElementById("mark-paid-modal").style.display = "flex";
      }

      function closeMarkPaidModal() {
        document.getElementById("mark-paid-modal").style.display = "none";
        document.getElementById("mark-paid-form").reset();
      }

      // Handle mark as paid form submission
      document.getElementById("mark-paid-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        const paymentMethod = document.getElementById("paid-payment-method").value;
        const transactionId = document.getElementById("paid-transaction-id").value.trim();
        const notes = document.getElementById("paid-notes").value.trim();

        if (!paymentMethod) {
          showMessage("payment-status", "Please select a payment method", "error", 3000);
          return;
        }

        // Get the first unpaid invoice (or create one if needed)
        // For now, we'll need to track invoices. Let's get them from the dashboard data
        if (!currentInvoices || currentInvoices.length === 0) {
          showMessage(
            "payment-status",
            "No invoices found. Please contact support.",
            "error",
            5000
          );
          return;
        }

        // Find first unpaid invoice
        const unpaidInvoice = currentInvoices.find((inv) => inv.status === "unpaid");
        if (!unpaidInvoice) {
          showMessage("payment-status", "No unpaid invoices found", "warning", 3000);
          return;
        }

        try {
          const response = await fetch(
            `${API_BASE}/api/client/invoices/${unpaidInvoice.id}/mark-payment`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${session.access_token}`,
              },
              body: JSON.stringify({
                payment_method: paymentMethod,
                transaction_id: transactionId,
                notes: notes,
              }),
            }
          );

          if (!response.ok) {
            const data = await response.json();
            throw new Error(data.error || "Failed to mark payment");
          }

          const data = await response.json();
          closeMarkPaidModal();
          showMessage(
            "payment-status",
            "‚úì Payment marked successfully! We'll verify it shortly.",
            "success",
            5000
          );

          // Reload client data to update balance
          setTimeout(() => {
            loadClientData();
          }, 1000);
        } catch (error) {
          console.error("Error marking payment:", error);
          showMessage("payment-status", `Error: ${error.message}`, "error", 5000);
        }
      });

      // Close modal on background click
      document.getElementById("mark-paid-modal").addEventListener("click", (e) => {
        if (e.target === document.getElementById("mark-paid-modal")) {
          closeMarkPaidModal();
        }
      });

      // Initial load
      loadClientData();
    </script>
  </body>
</html>
