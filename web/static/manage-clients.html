<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Manage clients - Xcellent1 Lawn Care" />
    <title>Client Management | Xcellent1</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      .management-header {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        color: white;
        padding: 2rem 1.5rem;
        margin-bottom: 1.5rem;
      }
      .management-title {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
      }
      .search-bar {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
      }
      .search-input {
        flex: 1;
        min-width: 200px;
        padding: 0.75rem;
        border: 1px solid var(--color-border);
        border-radius: 8px;
        font-size: 1rem;
      }
      .filter-select {
        padding: 0.75rem;
        border: 1px solid var(--color-border);
        border-radius: 8px;
        font-size: 1rem;
      }
      .clients-table {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      .table {
        width: 100%;
        border-collapse: collapse;
      }
      .table th {
        background: var(--color-bg);
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: var(--color-text-secondary);
        font-size: 0.875rem;
        text-transform: uppercase;
      }
      .table td {
        padding: 1rem;
        border-top: 1px solid var(--color-border);
      }
      .table tr:hover {
        background: var(--color-bg);
        cursor: pointer;
      }
      .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }
      .status-active {
        background: #dcfce7;
        color: #166534;
      }
      .status-paused {
        background: #fef3c7;
        color: #92400e;
      }
      .status-cancelled {
        background: #fee2e2;
        color: #991b1b;
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }
      .modal.active {
        display: flex;
      }
      .modal-content {
        background: white;
        border-radius: 16px;
        max-width: 600px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
      }
      .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--color-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .modal-title {
        font-size: 1.25rem;
        font-weight: 700;
      }
      .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--color-text-secondary);
      }
      .modal-body {
        padding: 1.5rem;
      }
      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
      }
      .form-group-full {
        grid-column: 1 / -1;
      }
      .action-buttons {
        display: flex;
        gap: 0.5rem;
      }
      .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="navbar-brand">
        <img src="images/xcellent1-logo-transparent.png" alt="Xcellent1 logo" class="navbar-logo" />
        <div class="navbar-title">
          <span class="navbar-name">XCELLENT1</span>
          <span class="navbar-tagline">LAWN CARE</span>
        </div>
      </div>
      <div class="navbar-links">
        <a href="owner.html" class="navbar-link">Dashboard</a>
        <a href="manage-clients.html" class="navbar-link active">Clients</a>
        <a href="manage-jobs.html" class="navbar-link">Jobs</a>
        <a href="manage-invoices.html" class="navbar-link">Invoices</a>
        <button onclick="logout()" class="btn btn-sm">Logout</button>
      </div>
    </nav>

    <div class="management-header">
      <div class="management-title">Client Management</div>
      <p style="opacity: 0.9; margin: 0;">Manage customer accounts and service plans</p>
    </div>

    <main class="container">
      <div class="search-bar">
        <input type="text" class="search-input" placeholder="Search clients by name, email, or address..." id="client-search" />
        <select class="filter-select" id="status-filter">
          <option value="">All Status</option>
          <option value="active">Active</option>
          <option value="paused">Paused</option>
          <option value="cancelled">Cancelled</option>
        </select>
        <button class="btn" onclick="openAddClientModal()">+ Add Client</button>
      </div>

      <div id="status-message" role="alert" aria-live="polite"></div>

      <div class="clients-table">
        <table class="table">
          <thead>
            <tr>
              <th>Client Name</th>
              <th>Address</th>
              <th>Service Plan</th>
              <th>Status</th>
              <th>Balance</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="clients-tbody">
            <tr>
              <td colspan="6" style="text-align: center; padding: 3rem;">
                <div class="spinner"></div>
                <div style="margin-top: 1rem;">Loading clients...</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>

    <!-- Add/Edit Client Modal -->
    <div id="client-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="modal-title">Add New Client</h2>
          <button class="modal-close" onclick="closeClientModal()">&times;</button>
        </div>
        <div class="modal-body">
          <form id="client-form" onsubmit="saveClient(event)">
            <input type="hidden" id="client-id" />

            <div class="form-grid">
              <div class="form-group">
                <label for="client-name">Full Name *</label>
                <input type="text" id="client-name" required class="form-control" />
              </div>
              <div class="form-group">
                <label for="client-email">Email *</label>
                <input type="email" id="client-email" required class="form-control" />
              </div>
            </div>

            <div class="form-grid">
              <div class="form-group">
                <label for="client-phone">Phone</label>
                <input type="tel" id="client-phone" class="form-control" placeholder="(555) 123-4567" />
              </div>
              <div class="form-group">
                <label for="client-status">Status</label>
                <select id="client-status" class="form-control">
                  <option value="active">Active</option>
                  <option value="paused">Paused</option>
                  <option value="cancelled">Cancelled</option>
                </select>
              </div>
            </div>

            <div class="form-group-full">
              <label for="property-address">Property Address *</label>
              <input type="text" id="property-address" required class="form-control" placeholder="123 Main St" />
            </div>

            <div class="form-grid">
              <div class="form-group">
                <label for="property-city">City</label>
                <input type="text" id="property-city" class="form-control" />
              </div>
              <div class="form-group">
                <label for="property-zip">ZIP Code</label>
                <input type="text" id="property-zip" class="form-control" />
              </div>
            </div>

            <div class="form-group-full">
              <label for="service-plan">Service Plan</label>
              <select id="service-plan" class="form-control">
                <option value="basic">Basic - Weekly Mowing</option>
                <option value="premium">Premium - Mow + Edge + Blow</option>
                <option value="deluxe">Deluxe - Full Service + Fertilizer</option>
                <option value="custom">Custom Plan</option>
              </select>
            </div>

            <div class="form-grid">
              <div class="form-group">
                <label for="property-size">Property Size (sq ft)</label>
                <input type="number" id="property-size" class="form-control" placeholder="5000" />
              </div>
              <div class="form-group">
                <label for="pricing">Price per Service ($)</label>
                <input type="number" id="pricing" class="form-control" step="0.01" placeholder="50.00" />
              </div>
            </div>

            <div class="form-group-full">
              <label for="notes">Notes</label>
              <textarea id="notes" class="form-control" rows="3" placeholder="Gate code, special instructions, etc."></textarea>
            </div>

            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
              <button type="button" class="btn btn-secondary" onclick="closeClientModal()">Cancel</button>
              <button type="submit" class="btn">Save Client</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="app.js"></script>
    <script type="module">
      import { requireAuth, logout } from './auth-helper.js';

      // Require owner authentication
      const userProfile = await requireAuth('owner');
      window.ownerProfile = userProfile;
    </script>
    <script>
      let clientsData = [];
      let editingClientId = null;

      // Load clients from API
      async function loadClients() {
        try {
          const token = window.supabaseSession?.access_token;
          if (!token) {
            throw new Error('No authentication token');
          }

          const response = await fetch('/api/owner/clients', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (!response.ok) {
            throw new Error(`API error: ${response.status}`);
          }

          const data = await response.json();
          if (!data.ok) {
            throw new Error(data.error || 'Failed to fetch clients');
          }

          clientsData = data.clients || [];
          renderClients(clientsData);
        } catch (err) {
          console.error('Failed to load clients:', err);
          showMessage('⚠️ Unable to load clients. Please refresh the page.', 'warning');
          // Show empty state
          document.getElementById('clients-tbody').innerHTML = `
            <tr>
              <td colspan="6" style="text-align: center; padding: 3rem; color: var(--color-text-secondary);">
                No clients found. Click "Add Client" to get started.
              </td>
            </tr>
          `;
        }
      }

      // Render clients table
      function renderClients(clients) {
        const tbody = document.getElementById('clients-tbody');

        if (clients.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" style="text-align: center; padding: 3rem; color: var(--color-text-secondary);">
                No clients found. Click "Add Client" to get started.
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = clients.map(client => `
          <tr onclick="editClient('${client.id}')">
            <td><strong>${client.name || 'N/A'}</strong></td>
            <td>${client.property_address || 'N/A'}</td>
            <td>${client.service_plan || 'None'}</td>
            <td><span class="status-badge status-${client.status || 'active'}">${client.status || 'active'}</span></td>
            <td>$${(client.balance || 0).toFixed(2)}</td>
            <td class="action-buttons">
              <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); editClient('${client.id}')">Edit</button>
              <button class="btn btn-sm" onclick="event.stopPropagation(); viewClient('${client.id}')">View</button>
            </td>
          </tr>
        `).join('');
      }

      // Search and filter
      document.getElementById('client-search').addEventListener('input', filterClients);
      document.getElementById('status-filter').addEventListener('change', filterClients);

      function filterClients() {
        const searchTerm = document.getElementById('client-search').value.toLowerCase();
        const statusFilter = document.getElementById('status-filter').value;

        const filtered = clientsData.filter(client => {
          const matchesSearch = !searchTerm ||
            (client.name || '').toLowerCase().includes(searchTerm) ||
            (client.email || '').toLowerCase().includes(searchTerm) ||
            (client.property_address || '').toLowerCase().includes(searchTerm);

          const matchesStatus = !statusFilter || client.status === statusFilter;

          return matchesSearch && matchesStatus;
        });

        renderClients(filtered);
      }

      // Modal functions
      function openAddClientModal() {
        editingClientId = null;
        document.getElementById('modal-title').textContent = 'Add New Client';
        document.getElementById('client-form').reset();
        document.getElementById('client-id').value = '';
        document.getElementById('client-modal').classList.add('active');
      }

      function closeClientModal() {
        document.getElementById('client-modal').classList.remove('active');
        editingClientId = null;
      }

      function editClient(clientId) {
        const client = clientsData.find(c => c.id === clientId);
        if (!client) return;

        editingClientId = clientId;
        document.getElementById('modal-title').textContent = 'Edit Client';
        document.getElementById('client-id').value = clientId;
        document.getElementById('client-name').value = client.name || '';
        document.getElementById('client-email').value = client.email || '';
        document.getElementById('client-phone').value = client.phone || '';
        document.getElementById('client-status').value = client.status || 'active';
        document.getElementById('property-address').value = client.property_address || '';
        document.getElementById('property-city').value = client.property_city || '';
        document.getElementById('property-zip').value = client.property_zip || '';
        document.getElementById('service-plan').value = client.service_plan || 'basic';
        document.getElementById('property-size').value = client.property_size || '';
        document.getElementById('pricing').value = client.pricing || '';
        document.getElementById('notes').value = client.notes || '';

        document.getElementById('client-modal').classList.add('active');
      }

      function viewClient(clientId) {
        // TODO: Navigate to client detail page
        window.location.href = `client-detail.html?id=${clientId}`;
      }

      // Save client
      async function saveClient(event) {
        event.preventDefault();

        const clientData = {
          name: document.getElementById('client-name').value,
          email: document.getElementById('client-email').value,
          phone: document.getElementById('client-phone').value,
          status: document.getElementById('client-status').value,
          property_address: document.getElementById('property-address').value,
          property_city: document.getElementById('property-city').value,
          property_zip: document.getElementById('property-zip').value,
          service_plan: document.getElementById('service-plan').value,
          property_size: document.getElementById('property-size').value,
          pricing: document.getElementById('pricing').value,
          notes: document.getElementById('notes').value
        };

        const submitBtn = event.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner"></span> Saving...';

        try {
          const token = window.supabaseSession?.access_token;
          const method = editingClientId ? 'PATCH' : 'POST';
          const url = editingClientId
            ? `/api/owner/clients/${editingClientId}`
            : '/api/owner/clients';

          const response = await fetch(url, {
            method,
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(clientData)
          });

          const data = await response.json();

          if (!response.ok || !data.ok) {
            throw new Error(data.error || 'Failed to save client');
          }

          showMessage(`✓ Client ${editingClientId ? 'updated' : 'added'} successfully!`, 'success');
          closeClientModal();
          await loadClients();
        } catch (err) {
          console.error('Failed to save client:', err);
          showMessage(`✗ ${err.message}`, 'error');
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = 'Save Client';
        }
      }

      function showMessage(message, type = 'info') {
        const container = document.getElementById('status-message');
        container.className = `message message-${type}`;
        container.textContent = message;
        container.style.display = 'block';

        setTimeout(() => {
          container.style.display = 'none';
        }, 5000);
      }

      // Initial load
      loadClients();
    </script>
  </body>
</html>
