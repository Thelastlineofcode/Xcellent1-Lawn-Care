# Xcellent1 Lawn Care - E2E Test Suite

This test suite implements comprehensive End-to-End (E2E) testing for all user
flows in the Xcellent1 Lawn Care application using Acceptance Test-Driven
Development (ATDD) principles.

## Test Coverage

The test suite covers four main user journeys:

### 1. Owner Dashboard Flow

- Authentication and authorization
- Dashboard metrics and KPIs
- Client management (CRUD operations)
- Job scheduling and management
- Crew assignment and tracking
- Financial reporting and invoicing
- Performance analytics

### 2. Crew Mobile App Flow

- Crew member authentication
- Daily job assignments
- Job status updates (scheduled → in progress → completed)
- Time tracking and GPS location
- Photo documentation
- Client communication
- Equipment and supply management

### 3. Client Portal Flow

- Client account creation and login
- Service scheduling and booking
- Job status monitoring
- Payment processing
- Service history and invoices
- Communication with crew and owner
- Service plan management

### 4. Guest Public Flow

- Public website browsing
- Service information access
- Contact form submission
- Service quote requests
- Waitlist registration
- Basic company information

## Test Architecture

Following BMad test architecture patterns:

```
tests/
├── e2e/                          # End-to-end test files
│   └── comprehensive-user-flows.spec.ts
├── support/                      # Test support utilities
│   ├── factories/                # Data factories
│   │   ├── user-factory.ts
│   │   ├── client-factory.ts
│   │   └── job-factory.ts
│   ├── helpers/                  # Test helpers
│   │   └── auth-helper.ts
│   └── fixtures/                 # Test fixtures
│       └── test-fixture.ts
├── test-config.ts                # Global test configuration
├── run-tests.ts                  # Test runner script
└── README.md                     # This file
```

## Prerequisites

### Environment Variables

Set the following environment variables for test execution:

```bash
# Server connection
TEST_BASE_URL=http://localhost:8000

# Database connection (optional - tests will skip DB operations if not set)
DATABASE_URL=postgresql://user:password@localhost:5432/xcellent1_test

# Supabase JWT secret for token generation
SUPABASE_JWT_SECRET=your-supabase-jwt-secret
```

### Running Server

The E2E tests require the application server to be running. Start the server
before running tests:

```bash
deno run --allow-all server.ts
```

## Running Tests

### Option 1: Using the test runner (recommended)

```bash
deno run --allow-all tests/run-tests.ts
```

### Option 2: Direct Deno test command

```bash
deno test --allow-all --unstable tests/e2e/
```

### Option 3: Run specific test file

```bash
deno test --allow-all --unstable tests/e2e/comprehensive-user-flows.spec.ts
```

## Test Execution Modes

### Full E2E Mode (Requires running server)

- Tests make actual HTTP requests to the running server
- Validates complete user workflows end-to-end
- Requires `TEST_BASE_URL` environment variable

### Database Integration Mode (Optional)

- Tests can create and clean up test data in database
- Requires `DATABASE_URL` environment variable
- Falls back to mock data if database not available

### Mock Mode (Default fallback)

- Tests run with mocked data and responses
- No external dependencies required
- Useful for development and CI/CD

## Test Results

Tests are designed to fail initially (red phase of TDD). This is expected
behavior that guides implementation.

### Expected Failures (Red Phase)

- Authentication endpoints not implemented
- Dashboard API endpoints missing
- Client management APIs not built
- Job scheduling endpoints not available
- Payment processing not implemented

### Success Criteria (Green Phase)

- All tests pass when corresponding APIs are implemented
- User flows work end-to-end
- Data consistency maintained
- Error handling works correctly

## Development Workflow

1. **Red Phase**: Run tests to see failures (current state)
2. **Green Phase**: Implement APIs to make tests pass
3. **Refactor Phase**: Optimize implementation while keeping tests green

## Test Data

Tests use deterministic fake data generated by factories:

- Users: Realistic names, emails, roles
- Clients: Property addresses, service plans, contact info
- Jobs: Scheduled dates, service types, status tracking

## Performance Testing

Included performance validation tests:

- Response time validation (< 2 seconds for critical paths)
- Concurrent user simulation
- Memory usage monitoring
- Error rate tracking

## Debugging Tests

### Enable verbose logging

```bash
deno test --allow-all --unstable --v tests/e2e/
```

### Run single test

```bash
deno test --allow-all --unstable tests/e2e/comprehensive-user-flows.spec.ts --filter "owner dashboard login"
```

### Debug with breakpoints

Add `debugger;` statements in test code and run with:

```bash
deno test --allow-all --unstable --inspect-brk tests/e2e/
```

## CI/CD Integration

Tests are designed to run in automated pipelines:

```yaml
# Example GitHub Actions step
- name: Run E2E Tests
  run: deno run --allow-all tests/run-tests.ts
  env:
    TEST_BASE_URL: http://localhost:8000
    DATABASE_URL: ${{ secrets.DATABASE_URL }}
    SUPABASE_JWT_SECRET: ${{ secrets.SUPABASE_JWT_SECRET }}
```

## Contributing

When adding new tests:

1. Follow the factory pattern for test data
2. Use descriptive test names
3. Include both positive and negative test cases
4. Add performance assertions where appropriate
5. Update this README with new coverage areas

## Troubleshooting

### Common Issues

**Tests timeout**: Increase `TEST_TIMEOUT` in `test-config.ts`

**Database connection fails**: Check `DATABASE_URL` format and database
availability

**Server not responding**: Ensure server is running on `TEST_BASE_URL`

**JWT token errors**: Verify `SUPABASE_JWT_SECRET` is set correctly

### Getting Help

- Check test output for specific error messages
- Review server logs for API endpoint issues
- Verify environment variables are set correctly
- Run tests in mock mode to isolate issues
